<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>tasarch Movie Format | tasarch</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600" />
  <link rel="stylesheet" href="m-dark+documentation.compiled.css" />
  <link rel="stylesheet" href="fixes.css" />
  <link rel="icon" href="favicon-96x96.png" type="image/png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="index.html" id="m-navbar-brand" class="m-col-t-8 m-col-m-none m-left-m"><img src="icon.png" alt="" />tasarch</a>
      <div class="m-col-t-4 m-hide-m m-text-right m-nopadr">
        <a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
          <path id="m-doc-search-icon-path" d="m6 0c-3.31 0-6 2.69-6 6 0 3.31 2.69 6 6 6 1.49 0 2.85-0.541 3.89-1.44-0.0164 0.338 0.147 0.759 0.5 1.15l3.22 3.79c0.552 0.614 1.45 0.665 2 0.115 0.55-0.55 0.499-1.45-0.115-2l-3.79-3.22c-0.392-0.353-0.812-0.515-1.15-0.5 0.895-1.05 1.44-2.41 1.44-3.89 0-3.31-2.69-6-6-6zm0 1.56a4.44 4.44 0 0 1 4.44 4.44 4.44 4.44 0 0 1-4.44 4.44 4.44 4.44 0 0 1-4.44-4.44 4.44 4.44 0 0 1 4.44-4.44z"/>
        </svg></a>
        <a id="m-navbar-show" href="#navigation" title="Show navigation"></a>
        <a id="m-navbar-hide" href="#" title="Hide navigation"></a>
      </div>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-6 m-col-m-none">
            <li>
              <a href="pages.html">Pages</a>
              <ol>
                <li><a href="about.html">About</a></li>
                <li><a href="movie.html" id="m-navbar-current">tasarch Movie Format</a></li>
              </ol>
            </li>
            <li><a href="namespaces.html">Namespaces</a></li>
          </ol>
          <ol class="m-col-t-6 m-col-m-none" start="3">
            <li><a href="annotated.html">Classes</a></li>
            <li><a href="files.html">Files</a></li>
            <li class="m-show-m"><a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
              <use href="#m-doc-search-icon-path" />
            </svg></a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main><article>
  <div class="m-container m-container-inflatable">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <h1>
          tasarch Movie Format
        </h1>
        <nav class="m-block m-default">
          <h3>Contents</h3>
          <ul>
            <li><a href="#general">General Idea</a></li>
            <li>
              <a href="#autotoc_md17">Requirements</a>
              <ul>
                <li>
                  <a href="#hardreq">Hard Requirements</a>
                  <ul>
                    <li><a href="#inputs">Storing Inputs</a></li>
                    <li><a href="#initstate">Initial (Save) State</a></li>
                    <li><a href="#metadata">Various Important Metdata</a></li>
                    <li><a href="#autotoc_md18">IDK</a></li>
                  </ul>
                </li>
                <li><a href="#perfreq">Performance Requirements</a></li>
                <li>
                  <a href="#softreq">Soft Requirements</a>
                  <ul>
                    <li><a href="#savestates">Save States for Scrubbing, etc.</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#design">Proposed Design</a></li>
            <li><a href="#autotoc_md19">Serialization</a></li>
          </ul>
        </nav>
<p>This page outlines the plan for the tasarch Movie Format (TAM from now on). Hopefully, by first designing it, we can make something that actually works :).</p><aside class="m-note m-info"><h4>Note</h4><p>While the title (and TAM) might imply this document only deals with the on disk format, it actually deals with both (in memory representation and handling in the app). Discussing the in memory representation and what we need from it, is a lot more important IMO than the actual serialization format.</p></aside><section id="general"><h2><a href="#general">General Idea</a></h2><p>The general idea of TAM is to provide a recording of inputs to tasarch, such that it can be played back on any machine and arrive at the same state. This will be used in retroCTF to support challenges, where players are only allowed to send inputs.</p><p>While in theory this sounds relatively simple, there are a few hard requirements that make it much more difficult. All requirements will be discussed next.</p></section><section id="autotoc_md17"><h2><a href="#autotoc_md17">Requirements</a></h2><section id="hardreq"><h3><a href="#hardreq">Hard Requirements</a></h3><p>In the following, we discuss requirements that must be met under all circumstances.</p><section id="inputs"><h4><a href="#inputs">Storing Inputs</a></h4><p>Clearly the most important aspect of TAM and hence everything should focus on this :). Unfortunately, there are a few important aspects we need to support:</p><ol><li><strong>Multiple controllers</strong> (e.g. Player 1 and Player 2)</li><li><strong>Different controllers</strong> (e.g. SNES mouse), let&#x27;s not worry too much about this for now, but we should keep it in mind for future compatibility</li><li><p><strong>Correct synchronization to frames of core</strong>.</p><aside class="m-note m-dim"><h4><a href="todo.html#_todo000004" class="m-doc">Todo</a></h4><p>Figure out how this is done in BizHawk. What happens if you lag???</p></aside></li><li><strong>Support polling multiple times per frame</strong>, see <a href="https://tasvideos.org/7245S">https:/<wbr />/<wbr />tasvideos.org/<wbr />7245S</a> why this is necessary.</li></ol><p>I think supporting 4. and 2. will be the most difficult part.</p></section><section id="initstate"><h4><a href="#initstate">Initial (Save) State</a></h4><p>There should be an option to have a TAM specify an initialization state for the Core. This is necessary, as with certain challenges, we might want start at a certain point in the game. No point in the server being used to render the first 5 minutes of a game that is just cutscenes ;)</p><p>In my mind, the initial state is slightly different from the save states for scrubbing (see <a href="movie.html#savestates" class="m-doc">Save States</a>). I think, if enabled, the Core should always reset to that state, never to full uninit, unless explicitly done via some menu. However, in light that people might want to have multiple TAM at the same time, it might also make more sense to remove the initial state from TAM and solely use it in workspaces. (Future article discussing that is planned). I think it makes sense to include the initial state for now, it will bloat the size a lot though lul.</p></section><section id="metadata"><h4><a href="#metadata">Various Important Metdata</a></h4><p>We should save various important metadata in TAM, such as:</p><ul><li>MD5 of ROM (not necessarily bail on failure, but warn)</li><li>Core (with version)</li><li>Team Token / ID? -&gt; nice for stats</li><li><aside class="m-note m-dim"><h4><a href="todo.html#_todo000005" class="m-doc">Todo</a></h4><p>Probably more</p></aside></li></ul></section><section id="autotoc_md18"><h4><a href="#autotoc_md18">IDK</a></h4><aside class="m-note m-dim"><h4><a href="todo.html#_todo000006" class="m-doc">Todo</a></h4><p>Is there other stuff that are truly hard requirements?</p></aside></section></section><section id="perfreq"><h3><a href="#perfreq">Performance Requirements</a></h3><p>In the following, we discuss certain requirements regarding performance (such as size in memory / on disk), that dont really have hard lines, but should still be met.</p><p>In general, TAMs should be efficient to deal with, both for the on disk representation and the in memory one. In particular, the following operations should be fast:</p><ul><li>Serialization</li><li></li></ul></section><section id="softreq"><h3><a href="#softreq">Soft Requirements</a></h3><p>In the following, we discuss requirements that could be removed, if there is no way to meet them.</p><section id="savestates"><h4><a href="#savestates">Save States for Scrubbing, etc.</a></h4></section></section></section><section id="design"><h2><a href="#design">Proposed Design</a></h2><p>I propose the format is designed as follows (C++ classes, not necessarily how it looks on disk!).</p><aside class="m-note m-info"><h4>Note</h4><p>To solve the problem of polling input multiple times per frame, we introduce the notion of a &quot;subframe&quot;. Every time the input is polled (i.e. <code>retro_input_poll</code> called), a new subframe is started. A new frame starts right before calling into <code>retro_run</code>.</p></aside><pre class="m-code"><span class="cm">/*</span>
<span class="cm">    This captures the state of a singular input (e.g. a button on a controller or a touch on the screen) during a specific subframe.</span>

<span class="cm">    The saved properties directly correspond to the first four arguments of the `retro_input_state_t` callback.</span>
<span class="cm">    While with the additional structs introduced below, we would not need to necessarily save them again here, I think it could make sense for ease of access.</span>
<span class="cm">    But we will have to see if this bloats it too much.</span>
<span class="cm">    We could probably combine all these fields into a single uint64_t, since port is probably always smaller than 8, id smaller than 324 (keyboard max), index smaller than 10 (max num touches) and device at most 32 bits.</span>
<span class="cm">    Just counted, if we include everything, we have one bit too much :/.</span>
<span class="cm">    So we will have to see if it makes sense to worry about this lul.</span>

<span class="cm">    Since libretro didnt bother documenting any of the four parameters properly, I will also do that :)</span>

<span class="cm">    \todo Do we want to also save frame and subframe here?</span>
<span class="cm">*/</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">InputState</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        Player # / Port # of the corresponding device.</span>

<span class="cm">        MAX VAL: 8 (needs verifying)</span>
<span class="cm">        BITS: 3</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">port</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        Type of which device to poll for. This can also be a custom one, but libretro api says those should have the subclass masked away lul.</span>

<span class="cm">        MAX VAL: UINT32_MAX (but if we consider that we mask the subclass away, then it would only be 255)</span>
<span class="cm">        BITS: 32 (8)</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">device</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        The instance number of this specific input (i.e. a button that is somehow present multiple times?).</span>
<span class="cm">        This is only really used in two cases:</span>
<span class="cm">        - For touches, every index corresponds to a specific registered touch.</span>
<span class="cm">        - For analog, the index corresponds to the part of the analog controller queried (left stick, right stick and any of the buttons, clarified by id).</span>
<span class="cm">        This is imo kinda an abuse of the system, but whatever lul.</span>

<span class="cm">        MAX VAL: 10 (unless you somehow 11 fingers :P)</span>
<span class="cm">        BITS: 4</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        The identifier of the part of the device (e.g. which button) queried</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        The returned value. See libretro.h for details on what it means for different devices.</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        Whether this specific combination of port, device, index and id was actually read by the core.</span>
<span class="cm">        We can use this to detect potential desynchs:</span>

<span class="cm">        Let&#39;s imagine we record an input and (for some reason), the game only actually reads the inputs of two buttons of the controller, during recording.</span>
<span class="cm">        Now while playing back, it suddenly reads all inputs. Clearly this could lead to desynchs!</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">polled</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm">    As previously established, the four parameters to the retro_input_state function can fit together in a 64 bit int.</span>
<span class="cm">    Therefore, we use this as an index into a hashmap.</span>

<span class="cm">    \note I would probably actually implement this as a custom class.</span>
<span class="cm">*/</span><span class="w"></span>
<span class="k">using</span><span class="w"> </span><span class="n">InputStateKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint64_t</span><span class="p">;</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm">    Represents all available information about any inputs we have for a given subframe.</span>
<span class="cm">*/</span><span class="w"></span>
<span class="k">using</span><span class="w"> </span><span class="n">FullInputState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">InputStateKey</span><span class="p">,</span><span class="w"> </span><span class="n">InputState</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm">    Metadata that can be present on both frames and subframes.</span>
<span class="cm">*/</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">MetaData</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        Short label identifying this</span>
<span class="cm">        \todo Do we really want this?</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">label</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        Long form comment</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">comment</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        List of breakpoints for this location.</span>
<span class="cm">        Why multiple? Well, since gdb allows that, we can to support that as well!</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tasarch</span><span class="o">::</span><span class="n">dbg</span><span class="o">::</span><span class="n">breakpoint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">breakpoints</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">SubFrame</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO: keep track of these?</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">subframe</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">MetaData</span><span class="w"> </span><span class="n">metadata</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">FullInputState</span><span class="w"> </span><span class="n">full_input_state</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm">    This is to support stuff like, resetting the hardware, plugging in a new controller, etc.</span>
<span class="cm">    While this is represented using inheritance here, in e.g. protobuf this would be like a oneof.</span>
<span class="cm">    So this builds the base &quot;struct&quot;</span>
<span class="cm">*/</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">FrameEvent</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm">    Happens when the emulator is reset.</span>
<span class="cm">*/</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ResetEvent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FrameEvent</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm">    Happens when the controller is changed.</span>
<span class="cm">*/</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">SetControllerEvent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">FrameEvent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">port</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">device</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Frame</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SubFrame</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sub_frames</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Processed befoe the frame is rendered</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">FrameEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">events</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO save states?</span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">TAM</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO: general metadata</span>
<span class="w">    </span><span class="c1">// TODO: init save state</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Frame</span><span class="o">&gt;</span><span class="w"> </span><span class="n">frames</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span></pre></section><section id="autotoc_md19"><h2><a href="#autotoc_md19">Serialization</a></h2><p>There are multiple possibilities for how we could serialize such a format to disk. flatbuffers? protobuf? both probably require writing wrappers around the actual serialized classes. Custom binary format? way more error prone lol</p></section>
      </div>
    </div>
  </div>
</article></main>
<div class="m-doc-search" id="search">
  <a href="#!" onclick="return hideSearch()"></a>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-m-8 m-push-m-2">
        <div class="m-doc-search-header m-text m-small">
          <div><span class="m-label m-default">Tab</span> / <span class="m-label m-default">T</span> to search, <span class="m-label m-default">Esc</span> to close</div>
          <div id="search-symbolcount">&hellip;</div>
        </div>
        <div class="m-doc-search-content">
          <form>
            <input type="search" name="q" id="search-input" placeholder="Loading &hellip;" disabled="disabled" autofocus="autofocus" autocomplete="off" spellcheck="false" />
          </form>
          <noscript class="m-text m-danger m-text-center">Unlike everything else in the docs, the search functionality <em>requires</em> JavaScript.</noscript>
          <div id="search-help" class="m-text m-dim m-text-center">
            <p class="m-noindent">Search for symbols, directories, files, pages or
            modules. You can omit any prefix from the symbol or file path; adding a
            <code>:</code> or <code>/</code> suffix lists all members of given symbol or
            directory.</p>
            <p class="m-noindent">Use <span class="m-label m-dim">&darr;</span>
            / <span class="m-label m-dim">&uarr;</span> to navigate through the list,
            <span class="m-label m-dim">Enter</span> to go.
            <span class="m-label m-dim">Tab</span> autocompletes common prefix, you can
            copy a link to the result using <span class="m-label m-dim">⌘</span>
            <span class="m-label m-dim">L</span> while <span class="m-label m-dim">⌘</span>
            <span class="m-label m-dim">M</span> produces a Markdown link.</p>
          </div>
          <div id="search-notfound" class="m-text m-warning m-text-center">Sorry, nothing was found.</div>
          <ul id="search-results"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="search-v1.js"></script>
<script src="searchdata-v1.js" async="async"></script>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>tasarch. Created with <a href="https://doxygen.org/">Doxygen</a> 1.8.17 and <a href="https://mcss.mosra.cz/">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>
